<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="才权的博客">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="才权的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="才权的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/"/>





  <title> 才权的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4e94c4c1ded5d320541370545af638ea";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">才权的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/11/Step-by-Step带你玩转DuerOS-DuerOS客户端架构设计-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Caiquan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="才权的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/11/Step-by-Step带你玩转DuerOS-DuerOS客户端架构设计-6/" itemprop="url">
                  Step by Step带你玩转DuerOS - DuerOS客户端架构设计(6)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-11T21:44:23+08:00">
                2017-11-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于图片外链被禁止了，图片不能显示，完整文章看这里吧：<a href="https://www.jianshu.com/p/ab3ae8067bb8" target="_blank" rel="external">https://www.jianshu.com/p/ab3ae8067bb8</a></p>
<p>在前面的系列文章中，我们完整的分析了智能语音系统的系统组成，然后，我们提供了一个基于Python的DuerOS客户端供大家实际体验。这时候很多同学可能想：我能不能从零开始，完全的基于DuerOS提供的后台能力接口，用自己喜欢的语言（如C/C++、Java、ObjectC、Python、NodeJS），在自己熟悉的平台上（如Android、iOS、Linux、Windows、树莓派、单片机），自己独立完成DurOS的客户端开发呢？特别是对有产品化想法的同学，把DurOS的能力集成到自己的项目平台中。<br>这篇文章就跟大家一起来熟悉下DuerOS客户端实现的架构设计，主要是侧重对DuerOS客户端协议的解析（对于设备端开发过程中涉及到的更多细节，如AEC、采样率转换、音频焦点管理、混音处理），会在后面的文章中一一作出介绍和解析），希望这篇文章能对你的开发和工作有帮助。</p>
<h2 id="DuerOS客户端核心任务"><a href="#DuerOS客户端核心任务" class="headerlink" title="DuerOS客户端核心任务"></a>DuerOS客户端核心任务</h2><p>简单的说，客户端的主要任务就是，将用户的语音数据通过网络传给DuerOS后台，然后，执行DuerOS后台经过语音处理后的结果。<br>当然了如果，真是这么简单就好了~<br>具体的说，客户端需要完成的工作主要有，</p>
<ul>
<li>同DuerOS后台建立长链接，接收并处理DuerOS后台的推送命令（Directive）</li>
<li>上传用户录音数据到DuerOS后台服务器</li>
<li>执行上传录音后，DuerOS后台返回的控制命令（Directive）</li>
<li>上传设备事件[Event]到DuerOS后台服务端</li>
<li>通过Ping的方式保持链接<br>其中，<br>Directive：指DurOS服务端对客户端的控制命令，如播放一个语音，设置一个闹钟，播放一个音乐等等。<br>Event：指客户端上报当前发生的事件到DuerOS服务端，如音乐播放开始了，音乐播放结束了，闹铃开始响了，设备被唤醒并开始接受用户语音请求等等。在上传Event时，会附带设备当前的状态信息（ClientContext，如当前是否有音乐正在播放，播放到哪里了，设备端是否有设置闹铃，闹铃状态等等）。<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2>下面我们就结合具体场景和代码，逐个的来看各个部分是如何实现的。<br>分析场景:</li>
<li>用户语音输入“播放周杰伦的歌”</li>
<li>客户端上传用户的语音数据到DurOS后台服务器</li>
<li>DuerOS后台服务判断用户输入结束，下发停止录音Directive</li>
<li>客户端响应停止录音的Directive</li>
<li>客户端响应录音通道，服务端返回的需要播放歌曲的Directive</li>
<li>客户端上报开始音乐播放的状态到DuerOS后台服务器<h3 id="1-同DuerOS后台建立长链接，接收并处理DuerOS后台的推送命令（Directive）"><a href="#1-同DuerOS后台建立长链接，接收并处理DuerOS后台的推送命令（Directive）" class="headerlink" title="1. 同DuerOS后台建立长链接，接收并处理DuerOS后台的推送命令（Directive）"></a>1. 同DuerOS后台建立长链接，接收并处理DuerOS后台的推送命令（Directive）</h3>长链接主要实现DuerOS后台主动向客户端发送命令。比如，客户端一直向DuerOS后台发送数据，当DuerOS后台检测到用户输入结束时（VAD检测），DuerOS后台会主动通知客户端停止录音，并上传录音数据。<br>DuerOS的所有能力都是基于Http的（没有使用TCP/IP），为了实现长链接DuerOS的做法是：</li>
<li>客户端向DuerOS服务端发送get请求（设置较长的超时时间）</li>
<li>DuerOS服务端收到get请求后，并不立即回复</li>
<li>DuerOS服务端需要主动下发命令给客户端时，返回get结果</li>
<li>客户端通过接收get的返回内容，完成DuerOS服务端主动推动内容的接收<br>Python DuerOS客户端对应的代码实现(sdk/dueros_core.py)，<br><em>长链接建立：</em><br><img src="http://upload-images.jianshu.io/upload_images/4905018-4d9a1721507bebef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="长链接建立"></li>
</ul>
<p><em>DuerOS 下发Directive接收</em></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-536eeee3e75eb23c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="DuerOS 下发Directive接收"></p>
<h3 id="2-上传用户录音数据到DuerOS后台服务器"><a href="#2-上传用户录音数据到DuerOS后台服务器" class="headerlink" title="2. 上传用户录音数据到DuerOS后台服务器"></a>2. 上传用户录音数据到DuerOS后台服务器</h3><p>上传用户录音数据不单单是用户说话的音频流PCM数据，同时包括设备的状态信息（ClientContext），和开始录音的Event（ListenStarted）。状态和数据发送通过Post完成，Http的Body内容如下所示，</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-a353f89c6f568c45.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="用户录音数据上传报文格式"></p>
<p>其中，ClientContext、Event、和音频流PCM通过multipart+chunk的Http Post方式进行上传（后面可能会添加一个帖子，专门介绍下Http 1.0、1.1、 2.0、multipart、chunk传输等内容）。<br>Python DuerOS客户端对应实现（sdk/dueros_core.py），<br><img src="http://upload-images.jianshu.io/upload_images/4905018-b12be3fba76cf350.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="用户录音数据上传"></p>
<p>###3. 执行上传录音后，DuerOS后台返回的控制命令（Directive）<br>用户语音输入“播放周杰伦的音乐”后，语音上传通道会收到DuerOS后台服务器返回需要播放的音乐的Directive。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-3a61465f85971cfb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="录音上传后返回的Directive"></p>
<h3 id="4-客户端上传音乐开始播放的Event"><a href="#4-客户端上传音乐开始播放的Event" class="headerlink" title="4. 客户端上传音乐开始播放的Event"></a>4. 客户端上传音乐开始播放的Event</h3><p>音乐开始播放后，客户端上传音乐开始播放的Event到DuerOS服务端（sdk/interface/audio_player.py）<br><img src="http://upload-images.jianshu.io/upload_images/4905018-8fc5e96cec3343b6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="上传音乐开始播放的Event"></p>
<h3 id="5-Ping"><a href="#5-Ping" class="headerlink" title="5. Ping"></a>5. Ping</h3><p>Ping主要为了链接的维护。Http 1.0中每次Http 请求都需要进行TCP/IP的3次握手和4次挥手，Http1.1后支持连接复用，一次TCP/IP连接可以完成多次Http请求和回复。DuerOS使用Http2.0，为了避免链路上长时间没有数据传输而断开，使用Ping维持链接。<br>sdk/dureos_core.py<br><img src="http://upload-images.jianshu.io/upload_images/4905018-bff62564fccc0d81.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Ping"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="通路总结"><a href="#通路总结" class="headerlink" title="通路总结"></a>通路总结</h3><p>客户端同DuerOS服务端的通路一共有3个：</p>
<ul>
<li>长链接通路</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-d7be5cba60305187.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="长链接"></p>
<p>双向<br>客户端发送get请求<br>服务端通过get response的形式推送消息（如停止录音Directive）</p>
<ul>
<li>事件上报通路</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-a8b2d06e62454112.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="事件上报"></p>
<p>双向<br>客户端发送post请求（包含开始录音的Event、当前设备状态ClientContext、录音数据PCM）<br>服务端返回语音请求的结果（如播放歌曲的Directive）<br>客户端单独上传事件到DurOS服务端（如开始播放音乐）</p>
<ul>
<li>Ping通路</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-4ce59769a9bd22dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Ping"></p>
<p>单向<br>客户端通过get形式在链路没数据时发送Ping数据包</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li>事件（Event）和设备当前状态（ClientContext）一定是一起发送的</li>
<li>Directive下发通道<br>长链接通道和事件上报通路（录音数据上传）都会下发Directive（如，长链接会下发停止录音的Directive，录音上传通道会下发包含音乐播放内容的音乐播放Directive）</li>
<li>Event上传通道<br>录音数据上传（包括开始录音Event、当前设备状态ClientContext和录音数据PCM）和单独的事件上报（如音乐开始播放）共用同一通道</li>
<li>Http技术细节<br>Http2.0特性<br>链接复用<br>MultiPart<br>Chunk<br>Ping连接维护<br>关于Http相关的技术细节后面专门写篇帖子吧</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/11/Step-by-Step带你玩转DuerOS-唤醒词替换-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Caiquan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="才权的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/11/Step-by-Step带你玩转DuerOS-唤醒词替换-5/" itemprop="url">
                  Step by Step带你玩转DuerOS - 唤醒词替换(5)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-11T21:43:25+08:00">
                2017-11-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于图片外链被禁止了，图片不能显示，完整文章看这里吧：<a href="https://www.jianshu.com/p/96284d314cbe" target="_blank" rel="external">https://www.jianshu.com/p/96284d314cbe</a></p>
<p>当前Python版本的DuerOS只能通过[小度小度]进行唤醒。论坛里和群里很多同学问：“那如果我想通过[大白大白]，[叮当叮当]或者[你好]这样的自定义唤醒词来唤醒DuerOS改怎么做呢？”<br>自定义唤醒词其实超简单，下面我们就一步一步的来更换唤醒词。</p>
<h2 id="1-在snowboy平台训练自己的唤醒词"><a href="#1-在snowboy平台训练自己的唤醒词" class="headerlink" title="1 在snowboy平台训练自己的唤醒词"></a>1 在snowboy平台训练自己的唤醒词</h2><p>先附上snowboy的官方地址：<a href="https://snowboy.kitt.ai/" target="_blank" rel="external">https://snowboy.kitt.ai/</a></p>
<h3 id="登陆"><a href="#登陆" class="headerlink" title="登陆"></a>登陆</h3><p><img src="http://upload-images.jianshu.io/upload_images/4905018-58440cde7df17e4c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="登陆入口"></p>
<h3 id="创建自定义的唤醒词"><a href="#创建自定义的唤醒词" class="headerlink" title="创建自定义的唤醒词"></a>创建自定义的唤醒词</h3><p><img src="http://upload-images.jianshu.io/upload_images/4905018-cc4cd746d64f2f3f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="自定义唤醒词创建"></p>
<h3 id="下载唤醒模型"><a href="#下载唤醒模型" class="headerlink" title="下载唤醒模型"></a>下载唤醒模型</h3><p>在线训练完成后，下载训练模型（本例中我的训练唤醒词为“小白”）</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-dbc4a26ff06ca8dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="唤醒模型下载"></p>
<p>下载的模型为”小白.pmdl”</p>
<h2 id="2-下载snowboy-python接口代码"><a href="#2-下载snowboy-python接口代码" class="headerlink" title="2 下载snowboy python接口代码"></a>2 下载snowboy python接口代码</h2><p>snowboy GitHub地址: <a href="https://github.com/Kitt-AI/snowboy" target="_blank" rel="external">https://github.com/Kitt-AI/snowboy</a></p>
<h3 id="Clone-snowboy接口代码"><a href="#Clone-snowboy接口代码" class="headerlink" title="Clone snowboy接口代码"></a>Clone snowboy接口代码</h3><pre><code>git clone https://github.com/Kitt-AI/snowboy.git
</code></pre><h3 id="生成平台代码"><a href="#生成平台代码" class="headerlink" title="生成平台代码"></a>生成平台代码</h3><p>在snowboy/swig/Python目录执行“make”命令，<br><img src="http://upload-images.jianshu.io/upload_images/4905018-b5507aa8dd21c2f1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="平台代码生成"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-d724412ee2566866.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="snowboy GitHub README.md"></p>
<h3 id="获得snowboy-python接口组件"><a href="#获得snowboy-python接口组件" class="headerlink" title="获得snowboy python接口组件"></a>获得snowboy python接口组件</h3><p>将snowboy/examples目录下的Python目录更名为snowboy</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-e2c29285cf7603ed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h2 id="3-Python-DuerOS-SDK代码更新"><a href="#3-Python-DuerOS-SDK代码更新" class="headerlink" title="3 Python DuerOS SDK代码更新"></a>3 Python DuerOS SDK代码更新</h2><p>有了上面的定制唤醒模型（小白.pmdl）和snowboy python接口组件，下面就可以更新Python DuerOS SDK的代码了。</p>
<h3 id="Python-DuerOS-中的app-snowboy目录内容更新"><a href="#Python-DuerOS-中的app-snowboy目录内容更新" class="headerlink" title="Python DuerOS 中的app/snowboy目录内容更新"></a>Python DuerOS 中的app/snowboy目录内容更新</h3><p>先删除Python DuerOS中的app/snowboy文件夹，然后再将步骤2中生成的snowboy文件夹拷贝到app/目录下，然后，将训练好的唤醒模型（小白.pmdl）拷贝到app/snowboy目录中。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-80b8c64b0d2fa0e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="snowboy目录"></p>
<h3 id="修改app-snowboy-snowboydecoder-py"><a href="#修改app-snowboy-snowboydecoder-py" class="headerlink" title="修改app/snowboy/snowboydecoder.py"></a>修改app/snowboy/snowboydecoder.py</h3><p>####[1]修改<strong> init </strong>（）函数<br>注释掉self.audio和self.stream_in<br><img src="http://upload-images.jianshu.io/upload_images/4905018-a73a594a7cc51d03.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="__init__"></p>
<h4 id="2-添加feed-data-方法"><a href="#2-添加feed-data-方法" class="headerlink" title="[2] 添加feed_data()方法"></a>[2] 添加feed_data()方法</h4><p><img src="http://upload-images.jianshu.io/upload_images/4905018-d8ce8225ea35022d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="添加feed_data()方法"></p>
<p>####[3] 修改terminate()方法</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-e144901202d0d27b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="更新terminate()方法"></p>
<h3 id="修改app-wakeup-trigger-main-py"><a href="#修改app-wakeup-trigger-main-py" class="headerlink" title="修改app/wakeup_trigger_main.py"></a>修改app/wakeup_trigger_main.py</h3><p>在main()方法中更新唤醒模型，</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-0f557429b6e0b5c3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="唤醒模型更新"></p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>经过上面的步骤，我们便能够更新成自己喜欢的唤醒词。但我们自定义的唤醒词还不是完美的。在测试中会发现唤醒率并不高。根本的原因在于我们自定义的唤醒词，训练语料条太少了（可能只有1组，3条）。要达到一个很好的唤醒率，需要进行大量丰富的语音样本训练才行。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-df186f9817c59151.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="训练样本"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/11/Step-by-Step带你玩转DuerOS-OAuth2-0全面解析-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Caiquan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="才权的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/11/Step-by-Step带你玩转DuerOS-OAuth2-0全面解析-4/" itemprop="url">
                  Step by Step带你玩转DuerOS - OAuth2.0全面解析 (4)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-11T21:42:32+08:00">
                2017-11-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于图片外链被禁止了，图片不能显示，完整文章看这里吧：<a href="https://www.jianshu.com/p/c0219b8a50cd" target="_blank" rel="external">https://www.jianshu.com/p/c0219b8a50cd</a></p>
<p>DuerOS的开发平台在创建产品时，有一步需要进行OAuth设置（<a href="http://open.duer.baidu.com/doc/overall/console-guide_markdown" target="_blank" rel="external">http://open.duer.baidu.com/doc/overall/console-guide_markdown</a>），<br><img src="http://upload-images.jianshu.io/upload_images/4905018-60bba90bdfea249e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="DuerOS OAuth配置"><br>很多同学到这个步骤估计会很困惑，OAuth是什么？这里设置的URL有是什么呢？那我们这篇文章就好好讲一讲OAuth到底是什么？在DuerOS的接入过程中又是怎么使用的。</p>
<h2 id="什么是OAuth"><a href="#什么是OAuth" class="headerlink" title="什么是OAuth"></a>什么是OAuth</h2><p> 其实OAuth在我们日常中是非常常见的，但可能你没有专门的关注过功能背后的实现原理。这里有一篇阮一峰老师专门介绍OAuth的文章《理解OAuth 2.0》(<a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html</a>)，这是我目前为止见得对OAuth讲解最浅显又是最全面的一篇（ps 阮一峰老师的文章质量都很高呀）。</p>
<h2 id="DuerOS是如何使用OAuth的"><a href="#DuerOS是如何使用OAuth的" class="headerlink" title="DuerOS是如何使用OAuth的"></a>DuerOS是如何使用OAuth的</h2><p>OAuth有4中授权模式，</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-ef5c25357e5d5e5c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="OAuth授权模式"></p>
<p>而DuerOS使用的便是其中功能最完整、流程最严密的授权码模式。下面我们通过Python版本的DuerOS客户端来分析下DuerOS对OAuth的使用。</p>
<h3 id="认证流程组成单元"><a href="#认证流程组成单元" class="headerlink" title="认证流程组成单元"></a>认证流程组成单元</h3><p>授权码模式的认证流程如下所示，</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-ec351bc35c5ffe90.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="授权码模式认证流程"></p>
<p>主要涉及到4个基本单元：</p>
<ul>
<li>A-用户客户端</li>
<li>B-用户端浏览器（完成URI重定向）</li>
<li>C-用户客户端对应的后台服务器</li>
<li>D-认证服务器</li>
</ul>
<p>针对于DuerOS Python客户端，A、B、C、D分别对应：</p>
<ul>
<li>A-auth.sh（app/auth.py）</li>
<li>B-系统浏览器</li>
<li>C-app/auth.py中创建的Tornado WebServer</li>
<li><p>D-百度的认证服务器</p>
<h3 id="OAuth认证流程"><a href="#OAuth认证流程" class="headerlink" title="OAuth认证流程"></a>OAuth认证流程</h3><p>下面我们结合代码，一步一步的解析OAuth的整个过程<br>####1.用户客户端（A）对应的后台服务器（C）创建<br>运行，</p>
<h1 id="auth-sh"><a href="#auth-sh" class="headerlink" title="./auth.sh"></a>./auth.sh</h1><p>Python客户端会创建一个本地的Tornado WebServer，</p>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-2d971c3a33e20398.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Tornado WebServer创建（app/auth.py）"></p>
<p>这个Tornado WebServer只是为了调试方便被部署在本地，实际项目应用中会作为独立的Web服务，部署在云端的。</p>
<h4 id="2-客户端（A）吊起本地浏览器（B）访问客户端对应的后台服务器（C）"><a href="#2-客户端（A）吊起本地浏览器（B）访问客户端对应的后台服务器（C）" class="headerlink" title="2. 客户端（A）吊起本地浏览器（B）访问客户端对应的后台服务器（C）"></a>2. 客户端（A）吊起本地浏览器（B）访问客户端对应的后台服务器（C）</h4><p>好像有些绕（汗。。。）</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-011f163eefc61fc5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="app/auth.py"></p>
<p>其中，URL（<a href="http://127.0.0.1:3000）就是客户端对应的后台服务器（C）的地址。" target="_blank" rel="external">http://127.0.0.1:3000）就是客户端对应的后台服务器（C）的地址。</a></p>
<h4 id="3-客户端对应的后台服务器（C）通过重定向的方式让客户端浏览器（B）对百度认证服务器（D）发送认证请求"><a href="#3-客户端对应的后台服务器（C）通过重定向的方式让客户端浏览器（B）对百度认证服务器（D）发送认证请求" class="headerlink" title="3. 客户端对应的后台服务器（C）通过重定向的方式让客户端浏览器（B）对百度认证服务器（D）发送认证请求"></a>3. 客户端对应的后台服务器（C）通过重定向的方式让客户端浏览器（B）对百度认证服务器（D）发送认证请求</h4><p>哎，好像更绕了（再汗。。。）</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-c2c2be2650e19f54.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="app/auth.py"></p>
<p>####4. 百度认证服务器（D）向客户端浏览器（B）返回用户登录页面<br><img src="http://upload-images.jianshu.io/upload_images/4905018-2ba2989d06355468.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="用户登录页面"></p>
<p>前面的步骤，用户客户端（A）、用户客户端对应的后台服务器（C）、百度认证服务器（D），三者之间的通信都需要客户端浏览器（B）进行重定向做请求转发。这样的过程是不是感觉很困惑呢？为啥非要通过浏览器（B）来做重定向请求转发呢？为啥不直接进行Http请求呢？<br>现在看到这个页面应该有答案了吧：需要由浏览器（B）来展示来自百度认证服务器（D）的认证页面，并完成用户身份认证的交互。</p>
<p>####5. 百度认证服务器（D）将授权码通过客户端浏览器（B）转发给客户端对应的后台服务器（C）<br>用户在第4步中输入账号、密码后，点击登录并授权。百度的认证服务器（D）会收到用户登录请求，然后将授权码通过客户端浏览器（B）重定向的方式发送给客户端对应的后台服务器（C）。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-ee62c52781a71782.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="app/auth.py"></p>
<h4 id="6-客户端后台服务器（C）通过授权码向百度认证服务器（D）请求Token"><a href="#6-客户端后台服务器（C）通过授权码向百度认证服务器（D）请求Token" class="headerlink" title="6. 客户端后台服务器（C）通过授权码向百度认证服务器（D）请求Token"></a>6. 客户端后台服务器（C）通过授权码向百度认证服务器（D）请求Token</h4><p>客户端后台服务器（C）通过上一步获得的授权码向百度认证服务器（D）请求授权，并获取Token，</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-21b5df4a851d3fda.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="app/auth.py"></p>
<h4 id="7-用户客户端（A）从客户端的后台服务器（C）中获取Token"><a href="#7-用户客户端（A）从客户端的后台服务器（C）中获取Token" class="headerlink" title="7. 用户客户端（A）从客户端的后台服务器（C）中获取Token"></a>7. 用户客户端（A）从客户端的后台服务器（C）中获取Token</h4><p>由于Python DuerOS客户端中的后台服务器（Tornado WebServer）就在本地，所以，Token可以直接获得，</p>
<h4 id="8-token使用"><a href="#8-token使用" class="headerlink" title="8. token使用"></a>8. token使用</h4><p>千辛万苦通过OAuth流程获取的Token其实在DuerOS的后续请求中只是一个字段而已，</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-9f955b8fbdc3c4b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="请求中的token字段"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/11/Step-by-Step带你玩转DuerOS-Python-DuerOS-SDK-树莓派平台-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Caiquan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="才权的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/11/Step-by-Step带你玩转DuerOS-Python-DuerOS-SDK-树莓派平台-3/" itemprop="url">
                  Step by Step带你玩转DuerOS - Python DuerOS SDK[树莓派平台] (3)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-11T21:41:26+08:00">
                2017-11-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于图片外链被禁止了，图片不能显示，完整文章看这里吧：<a href="https://www.jianshu.com/p/e689d770d99d" target="_blank" rel="external">https://www.jianshu.com/p/e689d770d99d</a></p>
<p>在前一个帖子中，给大家带来了Python版本的DuerOS SDK。但DuerOS的测试环境却声明为Ubuntu，相信很多同学会疑惑：Python不是跨平台的吗？为什么要限制测试平台呢？真实的情况呢是这样的：<br>首先，Python跨平台这个没毛病。但问题在于DuerOS运行所需要的依赖环境确实跟平台相关的。比如DuerOS是基于Http2 ALPN的，但树莓派官方镜像的OpenSSL并不支持，而对应的Python库依赖于OpenSSL。为了在树莓派平台上支持Python的DuerOS SDK，专门交叉编译了OpenSSL和Python。<br>所以，这里限制了平台主要是方便同学能将DuerOS快速的Run起来。当然，如果想在MacOS、Windows平台运行DuerOS Python SDK也是没问题的，只是在依赖配置方面可能要多花些时间。<br>好了，废话不多说，直接上干货：</p>
<h1 id="树莓派DuerOS-Python-版本支持"><a href="#树莓派DuerOS-Python-版本支持" class="headerlink" title="树莓派DuerOS Python 版本支持"></a>树莓派DuerOS Python 版本支持</h1><p>##准备<br>按照个人版使用说明完成如下3步（<a href="http://open.duer.baidu.com/doc/device-devkit/intro_markdown" target="_blank" rel="external">http://open.duer.baidu.com/doc/device-devkit/intro_markdown</a>）</p>
<ul>
<li>镜像下载，烧录安装</li>
<li>配网</li>
<li>验证“小度小度”</li>
</ul>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><ol>
<li><p>停止现有小度功能，因为会占用MIC资源</p>
<pre><code>sudo systemctl disable duer
sudo systemctl stop duer
</code></pre></li>
<li><p>安装依赖包</p>
<pre><code>sudo apt-get update
sudo apt-get install python-dateutil
sudo apt-get install gir1.2-gstreamer-1.0
sudo apt-get install python-pyaudio
sudo apt-get install libatlas-base-dev
sudo apt-get install python-dev        
sudo pip install tornado
sudo pip install hyper
</code></pre><p>hyper库用来支持http2.0 client, pyaudio用来支持录音，tornado用来完成oauth认证。</p>
</li>
<li><p>下载编译好的openssl和Python安装包，并进行安装, <strong>需要更新openssl才能支持python sdk的使用</strong>。</p>
<pre><code>*从如下地址下载openssl安装包*(链接: https://pan.baidu.com/s/1skAP6WH 密码: wknz)
*从如下地址下载python2.7.14安装包*(链接: https://pan.baidu.com/s/1o8MHkzK 密码: ngx4)

 tar -zxvf openssl1.1.tar.gz -C /usr
 tar -zxvf python2.7.14.tar.gz -C /usr/local/
 sudo rm -rf /usr/bin/python
 sudo ln -s /usr/local/python2.7.14/bin/python /usr/bin/python
</code></pre></li>
<li><p>下载Python SDK和参考示例代码</p>
<pre><code>git clone https://github.com/MyDuerOS/DuerOS-Python-Client.git
cd DuerOS-Python-Client
git checkout raspberry-dev
</code></pre></li>
</ol>
<p>##运行和测试</p>
<ol>
<li><p>授权</p>
<pre><code>./auth.py
</code></pre><p>直接运行使用默认的client_id和client_secret，开发者可以替换成自己在DuerOS开放平台申请的client_id和client_secret，进而实现在控制台自定义的配置属性。</p>
</li>
</ol>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-b8e7c555be24d4fb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="app/auth.py"></p>
<p>其中，<br>需要在开放平台中“安全设置”的“授权回调页”，设置成  </p>
<pre><code>http://127.0.0.1:3000/authresponse
</code></pre><p><img src="http://upload-images.jianshu.io/upload_images/4905018-caca627041b10380.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="授权回调页设置"></p>
<ol>
<li><p>唤醒加识别</p>
<pre><code>./wakeup_trigger_start.sh
</code></pre></li>
<li><p>enter按键触发识别</p>
<pre><code>./enter_trigger_start.sh
</code></pre></li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/11/Step-by-Step带你玩转DuerOS-DuerOS能力初体验-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Caiquan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="才权的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/11/Step-by-Step带你玩转DuerOS-DuerOS能力初体验-2/" itemprop="url">
                  Step by Step带你玩转DuerOS - DuerOS能力初体验(2)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-11T21:33:42+08:00">
                2017-11-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于图片外链被禁止了，图片不能显示，完整文章看这里吧：<a href="https://www.jianshu.com/p/267334be6954" target="_blank" rel="external">https://www.jianshu.com/p/267334be6954</a></p>
<p>有了前面两篇文章的介绍，相信大家已经跃跃欲试了，想最快的体验DuerOS的能力？那当然是下载DuerOS App啦，</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-dc6b78232b08c78a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="度秘App"></p>
<p>如果想在硬件上体验，可以尝试树莓派版本，</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-fbd911a8fa84a6ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="基于树莓派的个人开发套件"></p>
<p>项目地址：<a href="http://open.duer.baidu.com/doc/device-devkit/intro_markdown" target="_blank" rel="external">http://open.duer.baidu.com/doc/device-devkit/intro_markdown</a></p>
<p>但不论是手机端的App还是基于树莓派的个人开发套件，但都有一个开发者不能忍缺陷：只能“看”，不能“玩”。作为机智神勇的开发者，肯定需要能定制、能修改、能改造的。</p>
<h1 id="新的选择"><a href="#新的选择" class="headerlink" title="新的选择"></a>新的选择</h1><p>针对上面的情况，这里提供了一个Python版本的DuerOS。<br>项目地址：<a href="https://github.com/MyDuerOS/DuerOS-Python-Client" target="_blank" rel="external">https://github.com/MyDuerOS/DuerOS-Python-Client</a><br>之所以选择Python主要出于以下方面的考量：</p>
<ul>
<li>简单易学，即便是没有编程经验的同学也能快速上手</li>
<li>环境搭建简单，避免各种编译、链接问题</li>
<li>AI时代必备技能，AI时代你还不会Python？</li>
</ul>
<p>当前版本支持功能：</p>
<ul>
<li>完成OAuth 2.0认证</li>
<li>通过[Enter]键触发唤醒状态</li>
<li>支持天气、百科等TTS播放功能</li>
<li>支持音乐播放功能</li>
<li>支持闹铃功能</li>
<li>云端下发Directive显示</li>
</ul>
<p>后续会支持跟多的功能，比如，</p>
<ul>
<li>[小度，小度]语音唤醒</li>
<li>接入百度的技能平台，完成自定义功能</li>
</ul>
<p>希望大家把使用过程中遇到的问题提出来，便于后续的优化</p>
<h1 id="DuerOS-Python-Client使用说明"><a href="#DuerOS-Python-Client使用说明" class="headerlink" title="DuerOS-Python-Client使用说明"></a>DuerOS-Python-Client使用说明</h1><h2 id="运行依赖"><a href="#运行依赖" class="headerlink" title="运行依赖"></a>运行依赖</h2><ul>
<li>gstreamer1.0</li>
<li>gstreamer1.0-plugins-good</li>
<li>gstreamer1.0-plugins-ugly</li>
<li>python-gi</li>
<li>python-gst</li>
<li>gir1.2-gstreamer-1.0<h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2></li>
<li>Ubuntu 16.04</li>
<li><p>Python 2.7.12</p>
<h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><h3 id="项目获取"><a href="#项目获取" class="headerlink" title="项目获取"></a>项目获取</h3><p>通过git下载代码到本地</p>
<h1 id="git-clone-https-github-com-MyDuerOS-DuerOS-Python-Client-git"><a href="#git-clone-https-github-com-MyDuerOS-DuerOS-Python-Client-git" class="headerlink" title="git clone https://github.com/MyDuerOS/DuerOS-Python-Client.git"></a>git clone <a href="https://github.com/MyDuerOS/DuerOS-Python-Client.git" target="_blank" rel="external">https://github.com/MyDuerOS/DuerOS-Python-Client.git</a></h1></li>
</ul>
<h3 id="认证授权"><a href="#认证授权" class="headerlink" title="认证授权"></a>认证授权</h3><p>在DuerOS-Python-Client目录下执行</p>
<pre><code># ./auth.sh
</code></pre><h3 id="通过-Enter-键触发唤醒状态"><a href="#通过-Enter-键触发唤醒状态" class="headerlink" title="通过[Enter]键触发唤醒状态"></a>通过[Enter]键触发唤醒状态</h3><p>在DuerOS-Python-Client目录下执行</p>
<pre><code># ./enter_trigger_start.sh
</code></pre><p>然后，每次单击[Enter]键后进行语音输入</p>
<h3 id="通过-小度小度-触发唤醒状态"><a href="#通过-小度小度-触发唤醒状态" class="headerlink" title="通过[小度小度]触发唤醒状态"></a>通过[小度小度]触发唤醒状态</h3><p>在DuerOS-Python-Client目录下执行(暂时该功能还不支持)</p>
<pre><code># ./wakeup_trigger_start.sh
</code></pre><p>然后，每次通过[小度小度]进行唤醒，然后，进行语音输入</p>
<h2 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h2><p>DuerOS-Python-Client代码结构如下图所示，</p>
<p><img src="http://upload-images.jianshu.io/upload_images/4905018-159f48b317d7dcce.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="代码结构 "></p>
<p>其中，</p>
<p><em>DuerOS-Python-Client:项目根目录</em></p>
<ul>
<li>DuerOS-Python-Client/auth.sh:认证授权脚本</li>
<li>DuerOS-Python-Client/enter_trigger_start.sh:[Enter]按键触发唤醒脚本</li>
<li>DuerOS-Python-Client/wakeup_tirgger_start.sh:[小度小度]触发唤醒脚本</li>
</ul>
<p><em>DuerOS-Python-Client/app:应用目录</em></p>
<ul>
<li>DuerOS-Python-Client/app/auth.py:认证授权实现模块</li>
<li>DuerOS-Python-Client/app/enter_trigger_main.py:[Enter]按键触发唤醒实现模块</li>
<li>DuerOS-Python-Client/app/wakeup_tirgger_main.py:[小度小度]触发唤醒实现模块</li>
<li>DuerOS-Python-Client/app/framework:平台相关目录</li>
<li>DuerOS-Python-Client/app/framework/mic.py:录音模块(基于pyaudio)</li>
<li>DuerOS-Python-Client/app/framework/player.py:播放模块(基于GStreamer)</li>
<li>DuerOS-Python-Client/app/snowboy:snowboy唤醒引擎</li>
</ul>
<p><em>DuerOS-Python-Client/sdk:dueros sdk目录</em></p>
<ul>
<li>DuerOS-Python-Client/sdk/auth.py:授权相关实现</li>
<li>DuerOS-Python-Client/sdk/dueros_core.py:dueros交互实现</li>
<li>DuerOS-Python-Client/sdk/interface:端能力接口实现</li>
</ul>
<h2 id="SDK接口说明"><a href="#SDK接口说明" class="headerlink" title="SDK接口说明"></a>SDK接口说明</h2><h3 id="授权模块-sdk-auth"><a href="#授权模块-sdk-auth" class="headerlink" title="授权模块(sdk/auth)"></a>授权模块(sdk/auth)</h3><h4 id="授权接口"><a href="#授权接口" class="headerlink" title="授权接口"></a>授权接口</h4><p>用户通过授权接口完成基于OAuth2.0的认证授权流程</p>
<pre><code>def auth_request(client_id=CLIENT_ID, client_secret=CLIENT_SECRET):
&apos;&apos;&apos;
发起认证
:param client_id:开发者注册信息
:param client_secret: 开发者注册信息
:return:
&apos;&apos;&apos;
</code></pre><h3 id="DuerOS核心模块-sdk-dueros-core"><a href="#DuerOS核心模块-sdk-dueros-core" class="headerlink" title="DuerOS核心模块(sdk/dueros_core)"></a>DuerOS核心模块(sdk/dueros_core)</h3><h4 id="directive监听注册"><a href="#directive监听注册" class="headerlink" title="directive监听注册"></a>directive监听注册</h4><p>通过监听注册接口，用户可以获得云端下发的directive内容</p>
<pre><code>def set_directive_listener(self, listener):
&apos;&apos;&apos;
directive监听器设置
:param listener: directive监听器
:return:
&apos;&apos;&apos;
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/30/Step-by-Step带你玩转DuerOS-智能语音系统的系统组成（1）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Caiquan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="才权的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/30/Step-by-Step带你玩转DuerOS-智能语音系统的系统组成（1）/" itemprop="url">
                  Step-by-Step带你玩转DuerOS-智能语音系统的系统组成（1）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-30T16:50:00+08:00">
                2017-09-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一个完整的智能语音系统主要由如下几个核心部分组成：</p>
<ul>
<li>麦克风阵列</li>
<li>唤醒识别</li>
<li>语音识别（ASR）</li>
<li>自然语言处理（NLP/NLU）</li>
<li>内容召回<br>下面我们逐个介绍各个组成部分<h1 id="麦克风阵列"><a href="#麦克风阵列" class="headerlink" title="麦克风阵列"></a>麦克风阵列</h1>麦克风用来将模拟的声音信号转换为数字信号，核心器件是ADC（Analog to Digital Controller）控制器，我们在日常生活中常见的麦克风大多是单麦克风，外形如下图所示：</li>
</ul>
<p><img src="/2017/09/30/Step-by-Step带你玩转DuerOS-智能语音系统的系统组成（1）/singlemic.png" alt="单麦克风"></p>
<p>而在智能语音系统中，大多使用麦克风阵列，外形如下图所示：</p>
<p><img src="/2017/09/30/Step-by-Step带你玩转DuerOS-智能语音系统的系统组成（1）/multimic.png" alt="麦克风阵列"><br>麦克风阵列在硬件上可以简单的理解成，一个麦克风阵列由多个麦克风组成。图中的麦克风阵列，每个红框就是一个麦克风。<br>麦克风阵列和普通的单麦克风相比有什么样的优点和缺点呢？</p>
<h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><p>首先麦克风阵列具有更好的远场拾音效果，举个不太严谨的例子，使用单麦克风打电话，手机需要放在半米的范围之内，对方才能听清说话的声音；但使用麦克风阵列，手机放在3~5米的范围之内，对方也能清晰的听到语音。<br>其次，麦克风阵列能够获取声源的角度信息，也就是说能够辨别声音的来源，但单麦克风做不到。<br>所以，在大多的智能语音系统中均采用麦克风阵列，而百度的DuerOS个人开发套件使用的就是麦克风阵列（包含两个麦克风）。</p>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><p>最显著的缺点就是麦克风阵列的成本相比于单麦克风而言，价格会高出很多。</p>
<h2 id="技术点"><a href="#技术点" class="headerlink" title="技术点"></a>技术点</h2><ul>
<li>麦克风选型：驻极体/数字麦克风</li>
<li>麦克风一致性</li>
<li>AEC</li>
<li>波束合成</li>
<li>盲源分离<br>对具体的技术细节感兴趣的同学可以逐条了解下，这里就不逐一展开了。<h1 id="语音唤醒"><a href="#语音唤醒" class="headerlink" title="语音唤醒"></a>语音唤醒</h1>语音唤醒的常见场景就是用户使用唤醒词（如百度的“小度小度”，亚马逊的“Alex”）将设备激活。<br>实际上设备在通过唤醒词激活之前也是一直在工作的，设备一直在录音，并检查录音的数据中是否包含预设的唤醒词（如“小度小度”、“Alexa”），当检测到有唤醒词，设备便进入唤醒状态。<br>当前对于个人开发者相对友好的免费的唤醒引擎主要有：</li>
<li>SnowBoy (<a href="https://snowboy.kitt.ai/" target="_blank" rel="external">https://snowboy.kitt.ai/</a>)</li>
<li>Pocketsphinx (<a href="https://cmusphinx.github.io/wiki/tutorialpocketsphinx/" target="_blank" rel="external">https://cmusphinx.github.io/wiki/tutorialpocketsphinx/</a>)</li>
<li>Sensory (<a href="http://www.sensory.com" target="_blank" rel="external">http://www.sensory.com</a>)<br>目前，百度已全资收购了KITTAI（SnowBoy是KITTAI旗下产品），建议开发者直接使用SnowBoy作为唤醒引擎，同时，SnowBoy的唤醒词训练，及唤醒引擎的集成使用也很简洁方便。<h2 id="语音识别（ASR）"><a href="#语音识别（ASR）" class="headerlink" title="语音识别（ASR）"></a>语音识别（ASR）</h2>语音识别（ASR）简单的说就是讲语音转化为文本，目前几乎所有的语音系统都是先将语音转化为文本，然后再基于文本进行后续的语义理解和处理的。<h2 id="自然语言处理（NLP-NLU）"><a href="#自然语言处理（NLP-NLU）" class="headerlink" title="自然语言处理（NLP/NLU）"></a>自然语言处理（NLP/NLU）</h2>有了语言识别（ASR）获取的文本信息，后面就进入了自然语言处理单元了，可以说这个步骤是最接近我们概念上理解的人工智能了。这个部分会从输入文本中获取用户的意图和对应的关键信息。举个例子，对应用户输入请求：“我想听周杰伦的歌”，NLU会将请求拆解成如下的结构化结果：</li>
<li>意图：听歌</li>
<li>词槽：周杰伦<br>有了NLU的处理结果，就可以获取用户请求的结果了。<h2 id="内容召回"><a href="#内容召回" class="headerlink" title="内容召回"></a>内容召回</h2>假设你有两个资源库，其中，一个是电影库，一个是歌曲库。当接收NLU的处理结果后，从意图（听歌）上，你可以判别用户希望从歌曲库中获取资源，从词槽（周杰伦）可以判断用户想听歌曲的类别。有了意图和词槽就能从资源库中检索到用户期望的结果，并将结果按请求的路径返回。<h1 id="完整过程"><a href="#完整过程" class="headerlink" title="完整过程"></a>完整过程</h1>下面我们将上面的各个核心部分连贯起来，想象茶几上放着一个智能音响，用户坐在两米外的沙发上，用户通过语音发出请求“小度小度”，音响的提示灯亮起指示激活状态，用户说“我想听周杰伦的歌”，稍后，音响播放周杰伦的青花瓷。</li>
<li>满足远场（3~5米）拾音：麦克风阵列</li>
<li>提示灯亮起指示设备激活：唤醒引擎</li>
<li>语音请求转化为文本：语音识别（ASR）</li>
<li>从文本中识别出意图（听歌）和词槽（周杰伦）：自然语言处理（NLU）</li>
<li>通过意图和词槽返回结果：内容召回</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/30/Step-by-Step带你玩转DuerOS-写在最前面（0）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Caiquan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="才权的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/30/Step-by-Step带你玩转DuerOS-写在最前面（0）/" itemprop="url">
                  Step-by-Step带你玩转DuerOS-写在最前面（0）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-30T16:44:54+08:00">
                2017-09-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>07年之前的互联网时代，我们习惯于借助键盘鼠标跟智能设备进行交互；07年之后的移动互联网时代，我们习惯于借助触摸屏跟智能设备进行交互；如今人工智能技术逐渐成熟，借助智能语音交互系统，我们可通过自然的语音交互来控制设备，实现打电话、听音乐，看电视的需求。相信不久的将来，人和设备的对话交互会变成最自然的输入方式，变成生活中自然的习惯。那么，有没有可能我们自己打造一个属于自己的语音个人助手呢？比如，通过语音来控制家里的灯，风扇，帮我们做日程管理。答案是肯定的，借助DuerOS的能力，普通的开发者也能打造属于自己的个人语音助手。</p>
<h1 id="DuerOS开发当前面临的问题"><a href="#DuerOS开发当前面临的问题" class="headerlink" title="DuerOS开发当前面临的问题"></a>DuerOS开发当前面临的问题</h1><p>虽然DuerOS的新闻铺天盖地，但DuerOS具体是怎样的一种形态？具有怎样的能力？DuerOS的开发者网站有很多详细的信息，但对于普通的开发者又该如何开始使用DuerOS呢？是不是你也和我一样有如下的困惑呢？</p>
<ul>
<li>智能语音系统是如何组成的？麦克风阵列、AEC、唤醒、ASR、VAD、NLU、自定义Bot是什么意思？</li>
<li>百度的DuerOS从开发者的角度看，是怎样的一种形态？能够提供怎样的能力？</li>
<li>亚马逊的AVS是什么？百度的AVS兼容协议是什么？百度的DCS协议跟前两者又有什么区别？</li>
<li>认证授权是什么？OAuth2.0是什么？</li>
<li>Http2.0是什么？为什么选择Http2.0，而不是Http1.1或Http1.0？</li>
<li>什么是设备发现？什么是配网？什么是登陆？</li>
<li>DuerOS中的长链接建立，Ping机制，Directive下发，Event上传是什么？<h1 id="这个博客系列会包含哪些内容"><a href="#这个博客系列会包含哪些内容" class="headerlink" title="这个博客系列会包含哪些内容"></a>这个博客系列会包含哪些内容</h1>这个博客系列主要针对初级的开发者，一步一步的展示一个基于DuerOS平台的智能语音交互系统具体实现，在实现的过程中也会逐步解释背后的实现原理。希望能够通过这个博客系列，普通的开发者能够顺利搭建属于自己的智能语音系统。<h1 id="技术要求"><a href="#技术要求" class="headerlink" title="技术要求"></a>技术要求</h1></li>
<li>硬件平台：树莓派3B+DuerOS阵列版</li>
<li>编程语言：Python<h1 id="当前进度"><a href="#当前进度" class="headerlink" title="当前进度"></a>当前进度</h1>目前已经基于DuerOS的DCS协议实现了Python版本的初级原型<a href="https://github.com/MyDuerOS/MyAssistant" target="_blank" rel="external">https://github.com/MyDuerOS/MyAssistant</a><br>目前还存在一些问题，比如使用SnowBoy训练”小度小度”唤醒词，训练样本太少，唤醒不怎么灵敏，后期会逐步完善。<h1 id="后期规划"><a href="#后期规划" class="headerlink" title="后期规划"></a>后期规划</h1>后期会从零开始搭建基于DuerOS的智能语音助手，大概会遵从如下的步骤：</li>
<li>智能语音系统的系统组成</li>
<li>DuerOS开发者个人注册</li>
<li>树莓派硬件环境搭建</li>
<li>DuerOS系统组成</li>
<li>OAuth2.0认证授权</li>
<li>DuerOS中长链接建立，Ping机制，Directive下发，Event上传</li>
<li>设备发现，配网，认证</li>
<li>自定义Bot认证<br>欢迎搭建提出更多的问题，我会在后续的博客中进行补充。<h1 id="项目git地址："><a href="#项目git地址：" class="headerlink" title="项目git地址："></a>项目git地址：</h1><a href="https://github.com/MyDuerOS" target="_blank" rel="external">https://github.com/MyDuerOS</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/30/基于word2vec的词语相似度计算/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Caiquan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="才权的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/30/基于word2vec的词语相似度计算/" itemprop="url">
                  基于word2vec的词语相似度计算
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-30T16:37:28+08:00">
                2017-09-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h1><p>假设你有一个商品的数据库，比如：</p>
<table>
<thead>
<tr>
<th>商品名称</th>
<th>价格 </th>
</tr>
</thead>
<tbody>
<tr>
<td>椅子</td>
<td>200元/个</td>
</tr>
<tr>
<td>香蕉</td>
<td>6元/斤</td>
</tr>
<tr>
<td>冰箱</td>
<td>2000元/台</td>
</tr>
</tbody>
</table>
<p>现在通过用户的输入来检索商品的价格，最简单的方法就是通过字符串进行匹配，比如，<br>用户输入“椅子”，就用“椅子”作为关键字进行搜索，很容易找到椅子的价格就是200元/个。<br>但有时用户输入的是“凳子”，如果按照字符串匹配的方法，只能返回给用户，没有此商品。但实际上可以把“椅子”的结果返回给用户参考。这种泛化的能力，通过简单的字符串匹配是显然不能实现的。</p>
<h1 id="词语相似度计算"><a href="#词语相似度计算" class="headerlink" title="词语相似度计算"></a>词语相似度计算</h1><p>在上面的例子中，“凳子”跟“椅子”的语意更相近，跟“香蕉”或“冰箱”的语意相对较远。在商品搜索的过程中，可以计算用户输入的关键字与数据库中商品名间的相似度，在商品数据库中找出相似度最大的商品，推荐给用户。这种相近的程度就是词语的相似度。在实际的工程开发中可以通过word2vec实现词语相似度的计算。</p>
<h1 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h1><pre><code>from sklearn.datasets import fetch_20newsgroups

news = fetch_20newsgroups(subset=&apos;all&apos;)
X, y = news.data, news.target

from bs4 import BeautifulSoup
import nltk, re


# 把段落分解成由句子组成的list（每个句子又被分解成词语）
def news_to_sentences(news):
    news_text = BeautifulSoup(news, &apos;lxml&apos;).get_text()
    tokenizer = nltk.data.load(&apos;tokenizers/punkt/english.pickle&apos;)
    raw_sentences = tokenizer.tokenize(news_text)

    # 对每个句子进行处理，分解成词语
    sentences = []
    for sent in raw_sentences:
        sentences.append(re.sub(&apos;[^a-zA-Z]&apos;, &apos; &apos;, sent.lower().strip()).split())
    return sentences


sentences = []

for x in X:
    sentences += news_to_sentences(x)

# import numpy
# # 将预处理过的&quot;词库&quot;保存到文件中，便于调试
# numpy_array = numpy.array(sentences)
# numpy.save(&apos;sentences.npy&apos;, numpy_array)
#
# # 将预处理后的&quot;词库&quot;从文件中读出，便于调试
# numpy_array = numpy.load(&apos;sentences.npy&apos;)
# sentences = numpy_array.tolist()

num_features = 300
min_word_count = 20
num_workers = 2
context = 5
downsampling = 1e-3

from gensim.models import word2vec

model = word2vec.Word2Vec(sentences, workers=num_workers,         size=num_features, min_count=min_word_count, window=context,
                      sample=downsampling)

model.init_sims(replace=True)

# 保存word2vec训练参数便于调试
# model.wv.save_word2vec_format(&apos;word2vec_model.bin&apos;, binary=True)
# model.wv.load_word2vec_format(&apos;word2vec_model.bin&apos;, binary=True)

print &apos;词语相似度计算：&apos;
print &apos;morning vs morning:&apos;
print model.n_similarity(&apos;morning&apos;, &apos;morning&apos;)
print &apos;morning vs afternoon:&apos;
print model.n_similarity(&apos;morning&apos;, &apos;afternoon&apos;)
print &apos;morning vs hello:&apos;
print model.n_similarity(&apos;morning&apos;, &apos;hellow&apos;)
print &apos;morning vs shell:&apos;
print model.n_similarity(&apos;morning&apos;, &apos;shell&apos;)
</code></pre><h1 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h1><pre><code>/Users/liucaiquan/anaconda/bin/python /Users/liucaiquan/PycharmProjects/WordSimilarityCalculation/src/test.py
词语相似度计算：
morning vs morning:
1.0
morning vs afternoon:
0.871482091583
morning vs hello:
0.731609166442
morning vs shell:
0.709714434122
</code></pre><h1 id="调试技巧"><a href="#调试技巧" class="headerlink" title="调试技巧"></a>调试技巧</h1><p>在开发调试的过程中，会出现错误，需要重新运行程序。如果每次修改后，都从头开始执行，肯定会消耗很多无用的时间。比如，预处理后的文本结果和word2vec的训练参数，这些中间结果可以保持下来，当遇到问题时，就可以从文件中读取结果，而不需要每次都从头开始。</p>
<h1 id="源码下载地址"><a href="#源码下载地址" class="headerlink" title="源码下载地址"></a>源码下载地址</h1><p><a href="https://github.com/CaiquanLiu/MachineLearning" target="_blank" rel="external">https://github.com/CaiquanLiu/MachineLearning</a></p>
<h1 id="代码参考"><a href="#代码参考" class="headerlink" title="代码参考"></a>代码参考</h1><p>《Python机器学习及实践：从零开始通往Kaggle竞赛之路》</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/21/基于Python-Hyper实现Http2的multipart-form-data数据上传/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Caiquan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="才权的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/21/基于Python-Hyper实现Http2的multipart-form-data数据上传/" itemprop="url">
                  基于Python Hyper实现Http2的multipart/form-data数据上传
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-21T13:08:53+08:00">
                2017-07-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Http/2虽然推出已经不短了，但目前整体的使用率并不高，对应的支持库也并不理想，目前主要的支持库可以参考:<a href="https://github.com/http2/http2-spec/wiki/Implementations" target="_blank" rel="external">https://github.com/http2/http2-spec/wiki/Implementations</a></p>
<p>针对也Python，目前可选的库好像只有Hyper（<a href="http://hyper.readthedocs.io/en/latest/" target="_blank" rel="external">http://hyper.readthedocs.io/en/latest/</a>）。Hyper在官网当中声称对Requests有很好的支持，可以将Hyper集成到Request中，完成Requests对Http/2的支持，</p>
<p><img src="/2017/07/21/基于Python-Hyper实现Http2的multipart-form-data数据上传/requests集成hyper.png" alt="requests集成hyper"></p>
<p>但在实际开发中并不理想。比如，默认Request的请求超时时间是无限的，但通过集成Hyper来使用Requests进行get请求时，还是会出现超时的情况，所以，对于Http/2的开发，不建议使用这种方式。</p>
<h1 id="开发背景"><a href="#开发背景" class="headerlink" title="开发背景"></a>开发背景</h1><p>在开发“才权的AI小助手”过程中，进行了DuerOS云端接口的接入，DuerOS的云端接口是基于Http/2的，而且，需要使用multipart/form-data进行当前状态和语音数据流的上传。</p>
<p><img src="/2017/07/21/基于Python-Hyper实现Http2的multipart-form-data数据上传/DuerOS语音状态和数据上传格式.png" alt="DuerOS语音状态和数据上传格式"></p>
<p><a href="http://open.duer.baidu.com/doc/dueros-conversational-service/device-interface/voice-input_markdown" target="_blank" rel="external">http://open.duer.baidu.com/doc/dueros-conversational-service/device-interface/voice-input_markdown</a></p>
<h1 id="面临问题和解决方案"><a href="#面临问题和解决方案" class="headerlink" title="面临问题和解决方案"></a>面临问题和解决方案</h1><p>Hyper中并没有专门的接口用来实现multipart/form-data类型数据的上传，而是直接接收已经序列化后的body数据。</p>
<p><img src="/2017/07/21/基于Python-Hyper实现Http2的multipart-form-data数据上传/Hyper数据上传.png" alt="Hyper数据上传"></p>
<p>针对这种情况，我们可以Http协议的报文定义，来定制body的内容，最终实现Hyper对multipart/form-data类型数据上传的支持。</p>
<p><img src="/2017/07/21/基于Python-Hyper实现Http2的multipart-form-data数据上传/数据报文格式.png" alt="数据报文格式"></p>
<h1 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h1><p>对于DuerOS的语音请求，需要讲语音状态（Json串）和语音数据（PCM音频流）以multipart/form-data的形式进行上传。这里我们通过get_multipart_formed_data（）方法来定制body内容，</p>
<pre><code>&apos;&apos;&apos;
    msg_id：消息ID（messageId字段）
    dialog_req_id：对话ID（dialogRequestId字段）
    format：语音数据格式（format字段）
    data：语音raw data（pcm数据流）
&apos;&apos;&apos;
def get_multipart_formed_data(self, msg_id, dialog_req_id, format, data):

    event={&apos;clientContext&apos;:[&apos;ai.dueros.device_interface.alerts.AlertsState&apos;,&apos;ai.dueros.device_interface.audio_player.PlaybackState&apos;,&apos;ai.dueros.device_interface.speaker_controller.VolumeState&apos;,&apos;ai.dueros.device_interface.voice_output.SpeechState&apos;], \
   &apos;event&apos;:{&apos;header&apos;:{&apos;namespace&apos;:&apos;ai.dueros.device_interface.voice_input&apos;, \
                      &apos;name&apos;:&apos;ListenStarted&apos;, \
                      &apos;messageId&apos;:msg_id, \
                      &apos;dialogRequestId&apos;:dialog_req_id}, \
            &apos;payload&apos;:{&apos;format&apos;:format}}}

    event=json.dumps(event)

    post_data1=[]

    # ListenStarted事件
    post_data1.append(&apos;--&apos;+boundary)
    post_data1.append(&apos;Content-Disposition: form-data; name=&quot;metadata&quot;&apos;)
    post_data1.append(&apos;Content-Type: text/plain; charset=utf-8&apos;)
    post_data1.append(&apos;&apos;)
    post_data1.append(event)
#     post_data1.append(&apos;--&apos;+boundary+&apos;--&apos;)# test
    post_data1.append(&apos;&apos;)

#     return crlf.join(post_data1).encode(&apos;utf-8&apos;)# test

#     # Audio data
    post_data1.append(&apos;--&apos;+boundary)
    post_data1.append(&apos;Content-Disposition: form-data; name=&quot;audio&quot;&apos;)
    post_data1.append(&apos;Content-Type: application/octet-stream&apos;)
    post_data1.append(&apos;&apos;)

    body1=crlf.join(post_data1).encode(&apos;utf-8&apos;)

    body2=data

    post_data3=[]
    post_data3.append(&apos;--&apos;+boundary+&apos;--&apos;)
    post_data3.append(&apos;&apos;)
    body3=crlf.join(post_data3).encode(&apos;utf-8&apos;)

    upload_data=body1+b&apos;{0}&apos;.format(crlf)+body2+b&apos;{0}&apos;.format(crlf)+body3

    return upload_data
</code></pre><p>语音状态和数据上传，</p>
<pre><code>&apos;&apos;&apos;
    msg_id：消息ID（messageId字段）
    dialog_req_id：对话ID（dialogRequestId字段）
    format：语音数据格式（format字段）
    data：语音raw data（pcm数据流）
&apos;&apos;&apos;
def voice_raw_data_upload(self, msg_id, dialog_req_id, format, data):
    post_body=self.get_multipart_formed_data(msg_id, dialog_req_id, format, data)
    self.conn.request(&apos;POST&apos;, path_upload_voice_data, headers=self.headers, body=post_body)
    resp = self.conn.get_response()

    return resp.read()
</code></pre><h1 id="完整代码参考"><a href="#完整代码参考" class="headerlink" title="完整代码参考"></a>完整代码参考</h1><p>完整的代码可以参考<br><a href="https://caiquanliu.github.io/2017/07/21/Eddy%E7%9A%84AI%E5%B0%8F%E5%8A%A9%E6%89%8B-%E7%99%BE%E5%BA%A6DuerOS%E6%A8%A1%E5%9D%97%E6%8E%A5%E5%85%A5-23/" target="_blank" rel="external">《Eddy的AI小助手-百度DuerOS模块接入(23)》</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/21/Eddy的AI小助手-百度DuerOS模块接入-23/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liu Caiquan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="才权的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/21/Eddy的AI小助手-百度DuerOS模块接入-23/" itemprop="url">
                  Eddy的AI小助手-百度DuerOS模块接入(23)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-21T13:07:00+08:00">
                2017-07-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>目前开放语音能力的平台已经不少，但能够完整的端到端的解决方案，百度的DuerOS应该是最完善的一个。先前的DuerOS能力通过SDK的形式来提供，当前最新的DuerOS完全兼容亚马逊的AVS协议，并基于Http/2的网络请求对外提供能力。</p>
<h1 id="DuerOS开放平台地址"><a href="#DuerOS开放平台地址" class="headerlink" title="DuerOS开放平台地址"></a>DuerOS开放平台地址</h1><p><a href="http://open.duer.baidu.com/openduer/main/index" target="_blank" rel="external">http://open.duer.baidu.com/openduer/main/index</a></p>
<h1 id="DuerOS能力接入"><a href="#DuerOS能力接入" class="headerlink" title="DuerOS能力接入"></a>DuerOS能力接入</h1><p>AI小助手以模块的形式接入了DuerOS的能力，主要完成的工作包括：</p>
<ul>
<li>基于OAuth协议的Token获取；</li>
<li>基于Http/2 get的长链接建立；</li>
<li>基于Http/2 multipart-form-data语音状态和音频流的上传；</li>
</ul>
<p>其中，<br>Token的获取因为涉及到OAuth协议中对页面的交互，所以Token通过修改并运行DuerOS Java SDK，通过过程中打Log的方式直接过去Token，然后填写到AI小助手中进行测试使用；</p>
<p>Python的Http/2是基于Hyper的，基于multipart-form-data的数据上传操作可以参考：</p>
<p><a href="https://caiquanliu.github.io/2017/07/21/%E5%9F%BA%E4%BA%8EPython-Hyper%E5%AE%9E%E7%8E%B0Http2%E7%9A%84multipart-form-data%E6%95%B0%E6%8D%AE%E4%B8%8A%E4%BC%A0/" target="_blank" rel="external">《基于Python Hyper实现Http2的multipart/form-data数据上传》</a></p>
<h1 id="模块工程目录"><a href="#模块工程目录" class="headerlink" title="模块工程目录"></a>模块工程目录</h1><p><img src="/2017/07/21/Eddy的AI小助手-百度DuerOS模块接入-23/模块工程目录.png" alt="模块工程目录"></p>
<p>其中，</p>
<p>duerosdev：DuerOS模块<br>moduletests/dueros.py：测试代码</p>
<h1 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h1><p>Java代码：<a href="http://github.com/CaiquanLiu/MyWeChatService.git" target="_blank" rel="external">http://github.com/CaiquanLiu/MyWeChatService.git</a></p>
<p>Python代码：<a href="https://github.com/CaiquanLiu/MyTuringService" target="_blank" rel="external">https://github.com/CaiquanLiu/MyTuringService</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Liu Caiquan" />
          <p class="site-author-name" itemprop="name">Liu Caiquan</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">69</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liu Caiquan</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

<div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
